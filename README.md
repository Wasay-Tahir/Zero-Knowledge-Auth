# zk-login-flutter-node

End-to-end example of zk-based password login using a Circom circuit (Groth16), a TypeScript/Express backend, and a Flutter mobile client. The repo is a monorepo with four parts:

- backend/: Node.js/Express TypeScript server for registration, nonce issuance, proof verification (snarkjs), and JWT issuance
- circuits/: Circom v2 circuits and instructions to produce proving/verification artifacts
- mobile/: Flutter app handling client UX, local crypto helpers, and server-assisted proving flow
- contracts/: Optional Hardhat project to deploy an on-chain verifier generated by snarkjs

## Prerequisites

- Node.js ≥ 18 (detected: v18.20.8)
- Flutter SDK (detected: 3.29.3) and Dart (detected: 3.7.2)
- circom v2 (detected: 2.2.3)
- snarkjs CLI (use `npx snarkjs` or install globally)
- A recent `npm`

## Project structure

```
repo-root/
  backend/
    src/
      index.ts          # Express server, routes
      zk/verify.ts      # Groth16 verify
      zk/prove.ts       # Server-assisted proving via groth16.fullProve
      zk/hash.ts        # Poseidon helper (Node/circomlibjs)
  circuits/
    PasswordAuth.circom # Circuit: Poseidon(salt,password) == commitment; outputs challenge hash with nonce
    build/              # circom compiler outputs (WASM, R1CS)
    keys/               # Groth16 keys (.zkey)
    verification_key.json
  mobile/
    zk_login_app/
      lib/
        api.dart        # Backend API client
        main.dart       # UI and login/register flow
  contracts/
    ...                 # Optional Hardhat project and verifier
```

## Architecture and flow

- Registration: client computes commitment = Poseidon(salt, password) and registers `username + commitment (+ salt?)` with the backend.
- Login:
  - Client requests a one-time nonce from backend.
  - Prover inputs: { password, salt, nonce } → circuit outputs challenge hash and proof.
  - Proof is verified server-side → on success, backend deletes nonce and returns a JWT.
- Two paths supported by backend:
  - Client-provided proof: `/auth/verify` accepts `proof` and `publicSignals`.
  - Server-assisted proving: `/auth/login` runs `groth16.fullProve` using configured WASM/ZKey.

## Circuits: build and keys

- Compile the circuit and generate WASM

```bash path=null start=null
cd circuits
circom PasswordAuth.circom --r1cs --wasm -o build
```

- Groth16 setup (example, local/dev)

```bash path=null start=null
# Powers of tau
npx snarkjs powersoftau new bn128 12 pot12_0000.ptau -v
npx snarkjs powersoftau contribute pot12_0000.ptau pot12_0001.ptau --name="first" -v

# Circuit-specific keys
mkdir -p keys
npx snarkjs groth16 setup build/PasswordAuth.r1cs pot12_0001.ptau keys/PasswordAuth_0000.zkey
npx snarkjs zkey contribute keys/PasswordAuth_0000.zkey keys/PasswordAuth_final.zkey --name="phase2" -v

# Export verification key for backend verification
npx snarkjs zkey export verificationkey keys/PasswordAuth_final.zkey verification_key.json
```

Keep large proving artifacts (.zkey, .ptau) out of VCS. The backend consumes only the JSON verification key and optionally the WASM/ZKey for server-assisted proving.

## Backend (TypeScript/Express)

- Install and run in dev (tsx + nodemon)

```bash path=null start=null
cd backend
npm install
npm run dev
```

- Required environment variables (recommend setting from repo root so paths are absolute)

```bash path=null start=null
# from repo root
export REPO=$(pwd)
export PORT=3000
export JWT_SECRET=dev-secret-change-me
# Required for verification
export ZK_VKEY_PATH="$REPO/circuits/verification_key.json"
# Required for server-assisted proving
export ZK_WASM_PATH="$REPO/circuits/build/PasswordAuth_js/PasswordAuth.wasm"
export ZK_ZKEY_PATH="$REPO/circuits/keys/PasswordAuth_final.zkey"

# then start server
cd backend && npm run dev
```

- Minimal smoke tests (manual)

```bash path=null start=null
# Register: commitment is decimal string (Poseidon(salt,password))
curl -X POST http://localhost:$PORT/auth/register \
  -H 'Content-Type: application/json' \
  -d '{"username":"alice","commitment":"123456","salt":"789"}'

# Get a nonce
curl "http://localhost:$PORT/auth/nonce?username=alice"

# Server-assisted login (password/salt decimal-encoded)
curl -X POST http://localhost:$PORT/auth/login \
  -H 'Content-Type: application/json' \
  -d '{"username":"alice","password":"42"}'

# Client-provided proof verification (if generated on client)
curl -X POST http://localhost:$PORT/auth/verify \
  -H 'Content-Type: application/json' \
  -d '{"username":"alice","proof":{...},"publicSignals":["..."]}'  
```

Notes:
- `backend/package.json` dependencies include `snarkjs@^0.7.4`, `circomlibjs`, `express`, `jsonwebtoken`.
- Lint/tests: none configured; `npm run lint` is a placeholder.

## Mobile (Flutter)

- Create or open the app (already scaffolded under `mobile/zk_login_app`)

```bash path=null start=null
cd mobile/zk_login_app
flutter pub get
```

- Backend URL handling in app:
  - Defaults: iOS/macOS simulators use `http://localhost:3000`; Android emulator uses `http://10.0.2.2:3000`.
  - Override with a Dart define:

```bash path=null start=null
flutter run --dart-define=BACKEND_URL=http://<YOUR-LAN-IP>:3000
```

- Real device: ensure your phone and computer are on the same network and use the host machine's LAN IP.
- UI enforces numeric-only input for password and salt (decimal strings expected by the circuit).

## Contracts (optional)

- Initialize and generate verifier with Hardhat

```bash path=null start=null
cd contracts
npm init -y
npm i -D hardhat @nomicfoundation/hardhat-toolbox
npx hardhat  # scaffold
# Generate Verifier.sol from the zkey
npx snarkjs zkey export verifier \
  ../circuits/keys/PasswordAuth_final.zkey \
  contracts/Verifier.sol
```

## API reference (backend)

- POST `/auth/register` → body: `{ username, commitment, salt? }` → `200 { ok: true }`
- GET `/auth/nonce?username=...` → `200 { nonce, salt? }`
- POST `/auth/login` (server-assisted) → body: `{ username, password }` → `200 { token }`
- POST `/auth/verify` (client proof) → body: `{ username, proof, publicSignals }` → `200 { token }`

JWT secret is `JWT_SECRET`. Nonces are single-use; on successful verification the nonce is deleted.

## Versions and tooling

- Node: v18.20.8
- Flutter: 3.29.3
- Dart: 3.7.2
- circom: 2.2.3
- snarkjs: ^0.7.4 (use `npx snarkjs` or install globally)

## Troubleshooting

- ENOENT for WASM/ZKey/verification key:
  - Prefer absolute paths in env vars as shown above. Ensure files exist at those locations.
- Android emulator cannot reach `localhost`:
  - Use `http://10.0.2.2:3000` or override `BACKEND_URL`.
- Real device networking:
  - Use host machine LAN IP; ensure firewall permits inbound on `PORT`.
- CORS errors:
  - Backend includes `cors`; verify origin and headers if customizing.
- `snarkjs: command not found`:
  - Use `npx snarkjs ...` or `npm i -g snarkjs`.

## Security notes

- Use strong, secret `JWT_SECRET` in prod.
- Keep proving artifacts and keys secure; do not commit `.ptau`/`.zkey` to VCS.
- This project is for educational/dev use; audit before any production use.

## Roadmap / future work

- Client-side Poseidon in Dart for local commitment computation (parity with `circomlibjs` backend helper).
- Add tests (e.g., Jest for backend) and linting.
- Optional: on-chain verification contract and end-to-end demo.
